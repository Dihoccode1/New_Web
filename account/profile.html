<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Thông tin tài khoản</title>
    <link
      rel="stylesheet"
      href="../fontawesome-free-6.7.2-web/css/all.min.css"
    />
    <link rel="stylesheet" href="../bootstrap-4.6.2-dist/css/bootstrap.css" />
    <link rel="stylesheet" href="../assets/css/style.css" />
    <link rel="stylesheet" href="../assets/css/base.css" />
  </head>
  <body>
    <header class="header">
      <div class="topbar">
        <div class="container">
          <div class="topbar-right"></div>
        </div>
      </div>
    </header>

    <header class="mid-header">
      <div class="container">
        <div class="header-main">
          <div class="header-left">
            <!-- Chặn autofill & gõ dấu ok -->
            <form
              action="/search"
              method="get"
              class="search-bar"
              autocomplete="off"
            >
              <input
                type="text"
                name="query"
                placeholder="Tìm kiếm"
                autocomplete="off"
                autocapitalize="off"
                autocorrect="off"
                spellcheck="false"
                inputmode="search"
              />
              <button type="submit" aria-label="Tìm kiếm">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </form>
          </div>

          <div class="header-center">
            <a href="../index.html" class="logo">
              <img src="../assets/images/logo.jpg" alt="GENTLEMAN" />
            </a>
          </div>

          <div class="header-right">
            <a href="../giohang.html" class="cart-link">
              <i class="fa-solid fa-cart-shopping"></i>
              GIỎ HÀNG (<span class="cart-count">0</span>)
            </a>
          </div>
        </div>
      </div>
    </header>

    <nav class="main-nav">
      <ul>
        <li><a href="../index.html">TRANG CHỦ</a></li>
        <li><a href="../gioithieu.html">GIỚI THIỆU</a></li>
        <li>
          <a href="../sanpham/sanpham.html" class="js-products-url">SẢN PHẨM</a>
        </li>
        <li><a href="../tintuc.html">TIN TỨC</a></li>
        <li><a href="../lienhe.html">LIÊN HỆ</a></li>
      </ul>
    </nav>

    <script>
      (function (w, d) {
        // Lấy URL trang sản phẩm từ menu (ưu tiên .js-products-url)
        function getProductsURL() {
          var a =
            d.querySelector("nav.main-nav a.js-products-url") ||
            d.querySelector('nav.main-nav a[href*="/sanpham"]');
          return a && a.getAttribute("href")
            ? a.getAttribute("href")
            : "../sanpham/sanpham.html";
        }

        var form = d.querySelector(".search-bar");
        if (!form) return;

        form.addEventListener(
          "submit",
          function (e) {
            e.preventDefault();

            var input = form.querySelector(
              'input[name="query"], input[name="q"]'
            );
            var q = ((input && input.value) || "").trim().replace(/\s+/g, " ");
            var raw = getProductsURL();

            // Dùng URL để không bị nhân đôi ?q= và giữ các param khác nếu có
            var url = new URL(raw, w.location.origin);
            if (q) url.searchParams.set("q", q);
            else url.searchParams.delete("q");

            // Điều hướng sang trang sản phẩm với ?q=
            w.location.href = url.pathname + (url.search ? url.search : "");
          },
          { passive: false }
        );
      })(window, document);
    </script>

    <script>
      (function (w, d) {
        // gọi sau khi auth sẵn sàng
        function makeWelcomeClickable() {
          // ưu tiên phần tử của header mới
          var el = d.querySelector(".welcome-user");
          if (el) {
            // đã là <a>, đảm bảo đúng href
            el.setAttribute("href", "../account/profile.html");
            return;
          }

          // các trường hợp site cũ: #welcomeName, [data-welcome-name], .js-welcome-name
          var target = d.querySelector(
            "#welcomeName, [data-welcome-name], .js-welcome-name"
          );
          if (!target) return;

          // nếu chưa phải <a>, bọc lại thành <a>
          if (target.tagName !== "A") {
            var a = d.createElement("a");
            a.href = "../account/profile.html";
            a.className = "welcome-link";
            while (target.firstChild) a.appendChild(target.firstChild);
            target.appendChild(a);
          } else {
            target.setAttribute("href", "../account/profile.html");
          }
        }

        d.addEventListener("auth:ready", makeWelcomeClickable);
        if (w.AUTH && w.AUTH.ready) makeWelcomeClickable();
      })(window, document);
    </script>

    <div class="container py-5">
      <div class="row">
        <div class="col-md-6 mx-auto">
          <div class="card">
            <div class="card-body">
              <h3 class="card-title mb-4">Thông tin tài khoản</h3>
              <div id="profileInfo">
                <p>Đang tải...</p>
              </div>

              <button
                id="btnToggleEdit"
                class="btn btn-outline-dark mt-3"
                style="display: none"
              >
                Cập nhật thông tin
              </button>

              <div id="profileEdit" class="mt-3" style="display: none">
                <h5 class="mb-3">Thay đổi thông tin</h5>
                <form id="formProfile">
                  <div class="form-group">
                    <label for="profileName">Họ tên</label>
                    <input
                      type="text"
                      id="profileName"
                      name="fullname"
                      class="form-control"
                      required
                    />
                  </div>
                  <div class="form-group">
                    <label for="profilePhone">Số điện thoại</label>
                    <input
                      type="text"
                      id="profilePhone"
                      name="phone"
                      class="form-control"
                    />
                  </div>
                  <div class="form-group">
                    <label for="profileAddress">Địa chỉ</label>
                    <input
                      type="text"
                      id="profileAddress"
                      name="address"
                      class="form-control"
                    />
                  </div>
                  <button type="submit" class="btn btn-dark">
                    Lưu thay đổi
                  </button>
                </form>
              </div>

              <hr />
              <a href="../giohang.html" class="btn btn-primary"
                >Giỏ hàng của tôi</a
              >
              <a href="../account/orders.html" class="btn btn-outline-info"
                >Lịch sử mua hàng</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="site-footer">
        <div class="top-footer">
          <div class="container">
            <div class="row">
              <section class="widget-ft">
                <h4 class="title-menu">Thông tin</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="../index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="../gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="../sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="../tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="../lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hỗ trợ</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="../index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="../gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="../sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="../tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="../lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hướng dẫn</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="../index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="../gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="../sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="../tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="../lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Chính sách</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="../index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="../gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="../sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="../tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="../lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="wg-logo">
                <h4 class="title-menu">Liên hệ</h4>
                <ul class="contact">
                  <li>
                    <span class="txt_content_child">
                      <span
                        ><i
                          class="fa-solid fa-location-dot"
                          aria-hidden="true"
                        ></i
                      ></span>
                      140B-Tổ 3, Ấp Xóm Chùa,Tỉnh Tây Ninh
                    </span>
                  </li>
                  <li class="sdt">
                    <span
                      ><i class="fa-solid fa-phone" aria-hidden="true"></i
                    ></span>
                    <a href="tel:0338286525">0338286525</a>
                  </li>
                  <li class="sdt">
                    <span><i class="fa-solid fa-envelope"></i></span>
                    <a href="mailto:thanhloc29052006@gmail.com"
                      >thanhloc29052006@gmail.com</a
                    >
                  </li>
                </ul>
              </section>
            </div>
          </div>
        </div>

        <div class="mid-footer">
          <div class="container">
            <div class="row">
              <div class="fot_copyright">
                <span class="wsp"
                  ><span
                    >Cung cấp bởi <a href="javascript:;">Nhóm 7</a></span
                  ></span
                >
              </div>
              <nav class="fot_menu_copyright">
                <ul class="ul_menu_fot">
                  <li>
                    <a href="../index.html" title="Trang chủ">Trang chủ</a>
                  </li>
                  <li>
                    <a href="../gioithieu.html" title="Giới thiệu"
                      >Giới thiệu</a
                    >
                  </li>
                  <li>
                    <a href="../sanpham/sanpham.html" title="Sản phẩm"
                      >Sản phẩm</a
                    >
                  </li>
                  <li><a href="../tin-tuc.html" title="Tin tức">Tin tức</a></li>
                  <li><a href="../lienhe.html" title="Liên hệ">Liên hệ</a></li>
                </ul>
              </nav>
              <div class="pay_footer">
                <ul class="follow_option">
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_1.webp" alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_2.webp" alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_3.webp" alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_4.webp" alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_5.webp" alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_6.webp  " alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img src="../assets/images/pay_7.webp" alt="Payment"
                    /></a>
                  </li>
                </ul>
              </div>
              <a
                href="#"
                id="back-to-top"
                class="backtop"
                title="Lên đầu trang"
              >
                <i class="fa-solid fa-angle-up" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>

    <!-- Auth + Data + Store -->
    <script src="../assets/js/auth.js"></script>
    <script src="../assets/js/auth.modal.bridge.js"></script>
    <script src="../assets/js/products.seed.js"></script>
    <script src="../assets/js/store.js"></script>
    <script src="../assets/js/ui.js"></script>

    <script>
      (function (w, d) {
        const PROFILE_KEY = "sv_profiles_v1"; // { [email]: { phone, address } }
        const USERS_KEY = "sv_users_v1"; // [{ name, email, passHash, createdAt }]
        const AUTH_KEY = "sv_auth_user_v1"; // { name, email, loginAt }

        // Cờ tránh gắn event nhiều lần
        let profileUIInited = false;

        function goLogin() {
          w.location.href = "./login.html";
        }

        function safeJSON(key, def) {
          try {
            const raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : def;
          } catch (e) {
            console.warn("[PROFILE] Lỗi JSON", key, e);
            return def;
          }
        }

        function getCurrentUser() {
          if (w.AUTH && w.AUTH.user && w.AUTH.user.email) {
            return {
              name: w.AUTH.user.name || "",
              email: String(w.AUTH.user.email).toLowerCase(),
            };
          }

          const cur = safeJSON(AUTH_KEY, null);
          if (cur && cur.email) {
            return {
              name: cur.name || "",
              email: String(cur.email).toLowerCase(),
            };
          }

          return null;
        }

        function getExtraProfile(email) {
          if (!email) return {};
          const all = safeJSON(PROFILE_KEY, {});
          return all[String(email).toLowerCase()] || {};
        }

        function saveExtraProfile(email, data) {
          if (!email) return;
          const key = String(email).toLowerCase();
          const all = safeJSON(PROFILE_KEY, {});
          all[key] = Object.assign({}, all[key] || {}, data || {});
          localStorage.setItem(PROFILE_KEY, JSON.stringify(all));
          console.log("[PROFILE] Đã lưu hồ sơ", key, all[key]);
        }

        function updateUserName(email, newName) {
          if (!email) return;
          const key = String(email).toLowerCase();

          try {
            const list = safeJSON(USERS_KEY, []);
            let changed = false;
            list.forEach(function (u) {
              if (String(u.email || "").toLowerCase() === key) {
                u.name = newName;
                changed = true;
              }
            });
            if (changed) {
              localStorage.setItem(USERS_KEY, JSON.stringify(list));
              console.log("[PROFILE] Đã cập nhật tên trong sv_users_v1");
            }
          } catch (e) {
            console.warn(
              "[PROFILE] Không cập nhật được tên trong sv_users_v1:",
              e
            );
          }

          try {
            const cur = safeJSON(AUTH_KEY, null);
            if (cur && String(cur.email || "").toLowerCase() === key) {
              cur.name = newName;
              localStorage.setItem(AUTH_KEY, JSON.stringify(cur));
              console.log("[PROFILE] Đã cập nhật tên trong sv_auth_user_v1");
            }
          } catch (e) {
            console.warn(
              "[PROFILE] Không cập nhật được tên trong sv_auth_user_v1:",
              e
            );
          }

          if (
            w.AUTH &&
            w.AUTH.user &&
            String(w.AUTH.user.email || "").toLowerCase() === key
          ) {
            w.AUTH.user.name = newName;
            if (typeof w.AUTH.updateAuthUI === "function") {
              w.AUTH.updateAuthUI();
            }
            console.log("[PROFILE] Đã cập nhật tên trong AUTH.user");
          }
        }

        function renderProfile() {
          const info = d.getElementById("profileInfo");
          const btn = d.getElementById("btnToggleEdit");
          const edit = d.getElementById("profileEdit");
          const form = d.getElementById("formProfile");
          if (!info) return;

          const current = getCurrentUser();

          if (current && current.email) {
            const extra = getExtraProfile(current.email);

            info.innerHTML = `
          <dl class="row mb-0">
            <dt class="col-sm-4">Họ tên:</dt>
            <dd class="col-sm-8"><strong>${current.name || "—"}</strong></dd>

            <dt class="col-sm-4">Email:</dt>
            <dd class="col-sm-8">${current.email}</dd>

            <dt class="col-sm-4">Số điện thoại:</dt>
            <dd class="col-sm-8">${extra.phone || "Chưa cập nhật"}</dd>

            <dt class="col-sm-4">Địa chỉ:</dt>
            <dd class="col-sm-8">${extra.address || "Chưa cập nhật"}</dd>
          </dl>
        `;

            if (btn) btn.style.display = "inline-block";
            if (edit) edit.style.display = "none";

            if (form) {
              const nameInput = form.querySelector('[name="fullname"]');
              const phoneInput = form.querySelector('[name="phone"]');
              const addressInput = form.querySelector('[name="address"]');

              if (nameInput) nameInput.value = current.name || "";
              if (phoneInput) phoneInput.value = extra.phone || "";
              if (addressInput) addressInput.value = extra.address || "";
            }
          } else {
            info.innerHTML =
              '<p class="text-danger mb-0">Bạn chưa đăng nhập. <a href="./login.html">Đăng nhập ngay</a></p>';
            if (btn) btn.style.display = "none";
            if (edit) edit.style.display = "none";
          }
        }

        function initProfileUIOnce() {
          if (profileUIInited) {
            return; // đã gắn rồi thì thôi, không gắn lại
          }
          profileUIInited = true;

          const btn = d.getElementById("btnToggleEdit");
          const edit = d.getElementById("profileEdit");
          const form = d.getElementById("formProfile");

          if (btn && edit) {
            btn.addEventListener("click", function () {
              const current = getCurrentUser();
              if (!current) {
                alert("Bạn cần đăng nhập trước.");
                goLogin();
                return;
              }

              const isHidden =
                edit.style.display === "none" ||
                edit.style.display === "" ||
                edit.style.display === null;

              edit.style.display = isHidden ? "block" : "none";
            });
          }

          if (form) {
            form.addEventListener("submit", function (e) {
              e.preventDefault();

              const current = getCurrentUser();
              if (!current) {
                alert("Bạn cần đăng nhập trước.");
                goLogin();
                return;
              }

              const nameInput = form.querySelector('[name="fullname"]');
              const phoneInput = form.querySelector('[name="phone"]');
              const addressInput = form.querySelector('[name="address"]');

              const name = nameInput ? nameInput.value.trim() : "";
              const phone = phoneInput ? phoneInput.value.trim() : "";
              const address = addressInput ? addressInput.value.trim() : "";

              if (!name) {
                alert("Vui lòng nhập họ tên.");
                return;
              }

              updateUserName(current.email, name);
              saveExtraProfile(current.email, { phone, address });

              renderProfile();
              alert("Đã cập nhật thông tin tài khoản.");
              if (edit) edit.style.display = "none";
            });
          }
        }

        function bootstrap() {
          renderProfile();
          initProfileUIOnce();
        }

        if (d.readyState === "loading") {
          d.addEventListener("DOMContentLoaded", bootstrap);
        } else {
          bootstrap();
        }

        d.addEventListener("auth:ready", function () {
          // auth xong thì render lại, nhưng không gắn event lần 2
          renderProfile();
        });
      })(window, document);
    </script>
  </body>
</html>
