<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Giỏ hàng</title>
    <link rel="stylesheet" href="./bootstrap-4.6.2-dist/css/bootstrap.css" />
    <link
      rel="stylesheet"
      href="./fontawesome-free-6.7.2-web/css/all.min.css"
    />
    <link rel="stylesheet" href="./assets/css/style.css" />
    <link rel="stylesheet" href="./assets/css/base.css" />
    <style>
      /* Logo + Giỏ hàng mặc định (PC) */
.header-center .logo img {
  max-height: 50px;
  display: block;
}

.cart-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  font-weight: 600;
  color: #333;
  font-size: 14px;
}

.cart-link i {
  font-size: 18px;
}

/* MOBILE: Thu nhỏ logo để không che GIỎ HÀNG */
/* MOBILE: Thu nhỏ logo + chừa chỗ cho GIỎ HÀNG */
@media (max-width: 767.98px) {
  /* Ẩn cả khối search bên trái cho rộng */
  .header-left,
  .search-bar {
    display: none !important;
  }

  /* Header: chỉ còn logo + giỏ hàng trên 1 hàng */
  .header-main {
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
    padding: 8px 10px !important;
    gap: 8px !important;
  }

  /* Logo: giới hạn RÕ bề ngang, auto co theo, không tràn */
  .header-center {
    flex: 0 0 auto;
    max-width: 40% !important;      /* nếu vẫn to, giảm xuống 35% */
    overflow: hidden;
  }
  .header-center .logo img {
    max-width: 120px !important;     /* chỉnh 70–90 tuỳ mắt */
    height: auto !important;
    display: block;
  }

  /* Giỏ hàng: luôn thấy full bên phải */
  .header-right {
    flex: 0 0 auto;
  }
  .header-right .cart-link {
    display: inline-flex !important;
    align-items: center;
    gap: 4px;
    padding: 4px 6px !important;
    margin: 0 !important;
    font-size: 12px !important;
    white-space: nowrap !important;
  }
  .header-right .cart-link i {
    font-size: 15px !important;
  }
}


      .txt_content_child {
        font-size: 10px;
      }
      .sdt {
        font-size: 10px;
      }
      
    </style>
    <script src="./assets/js/auth.js"></script>
    <script src="./assets/js/products.seed.js"></script>
    <script src="./assets/js/store.js"></script>
    <script src="./assets/js/ui.js"></script>
  </head>
  <body>
    <header class="header">
      <div class="topbar">
        <div class="container">
          <div class="topbar-right"></div>
        </div>
      </div>
    </header>

    <header class="mid-header">
      <div class="container">
        <div class="header-main">
          <div class="header-left">
            <!-- Chặn autofill & gõ dấu ok -->
            <form
              action="/search"
              method="get"
              class="search-bar"
              autocomplete="off"
            >
              <input
                type="text"
                name="query"
                placeholder="Tìm kiếm"
                autocomplete="off"
                autocapitalize="off"
                autocorrect="off"
                spellcheck="false"
                inputmode="search"
              />
              <button type="submit" aria-label="Tìm kiếm">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </form>
          </div>

          <div class="header-center">
            <a href="./index.html" class="logo">
              <img src="./assets/images/logo.jpg" alt="GENTLEMAN" />
            </a>
          </div>

          <div class="header-right">
            <a href="./giohang.html" class="cart-link">
              <i class="fa-solid fa-cart-shopping"></i>
              GIỎ HÀNG (<span class="cart-count">0</span>)
            </a>
          </div>
        </div>
      </div>
    </header>

    <nav class="main-nav">
      <ul>
        <li><a href="./index.html">TRANG CHỦ</a></li>
        <li><a href="./gioithieu.html">GIỚI THIỆU</a></li>
        <li>
          <a href="./sanpham/sanpham.html" class="js-products-url">SẢN PHẨM</a>
        </li>
        <li><a href="./tintuc.html">TIN TỨC</a></li>
        <li><a href="./lienhe.html">LIÊN HỆ</a></li>
      </ul>
    </nav>

    <script>
      (function (w, d) {
        // Lấy URL trang sản phẩm từ menu (ưu tiên .js-products-url)
        function getProductsURL() {
          var a =
            d.querySelector("nav.main-nav a.js-products-url") ||
            d.querySelector('nav.main-nav a[href*="/sanpham"]');
          return a && a.getAttribute("href")
            ? a.getAttribute("href")
            : "./sanpham/sanpham.html";
        }

        var form = d.querySelector(".search-bar");
        if (!form) return;

        form.addEventListener(
          "submit",
          function (e) {
            e.preventDefault();

            var input = form.querySelector(
              'input[name="query"], input[name="q"]'
            );
            var q = ((input && input.value) || "").trim().replace(/\s+/g, " ");
            var raw = getProductsURL();

            // Dùng URL để không bị nhân đôi ?q= và giữ các param khác nếu có
            var url = new URL(raw, w.location.origin);
            if (q) url.searchParams.set("q", q);
            else url.searchParams.delete("q");

            // Điều hướng sang trang sản phẩm với ?q=
            w.location.href = url.pathname + (url.search ? url.search : "");
          },
          { passive: false }
        );
      })(window, document);
    </script>
    <script>
      (function (w, d) {
        // gọi sau khi auth sẵn sàng
        function makeWelcomeClickable() {
          // ưu tiên phần tử của header mới
          var el = d.querySelector(".welcome-user");
          if (el) {
            // đã là <a>, đảm bảo đúng href
            el.setAttribute("href", "./account/profile.html");
            return;
          }

          // các trường hợp site cũ: #welcomeName, [data-welcome-name], .js-welcome-name
          var target = d.querySelector(
            "#welcomeName, [data-welcome-name], .js-welcome-name"
          );
          if (!target) return;

          // nếu chưa phải <a>, bọc lại thành <a>
          if (target.tagName !== "A") {
            var a = d.createElement("a");
            a.href = "./account/profile.html";
            a.className = "welcome-link";
            // chuyển toàn bộ nội dung vào <a>
            while (target.firstChild) a.appendChild(target.firstChild);
            target.appendChild(a);
          } else {
            // đã là <a> thì gán href đúng
            target.setAttribute("href", "./account/profile.html");
          }
        }

        // chạy khi auth ready, và dự phòng nếu auth đã sẵn sàng
        d.addEventListener("auth:ready", makeWelcomeClickable);
        if (w.AUTH && w.AUTH.ready) makeWelcomeClickable();
      })();
    </script>

    <div class="container py-4">
      <div class="alert alert-info mb-3" id="userInfo" style="display: none">
        <i class="fas fa-user"></i> Giỏ hàng của:
        <strong id="userName"></strong> (<span id="userEmail"></span>)
      </div>
      <h3 class="mb-3">Giỏ hàng</h3>
      <div class="row">
        <div class="col-lg-8">
          <div class="table-responsive">
            <table class="table table-bordered align-middle" id="cartTable">
              <thead class="thead-light">
                <tr>
                  <th style="width: 60px"></th>
                  <th>Sản phẩm</th>
                  <th class="text-right" style="width: 140px">Đơn giá</th>
                  <th class="text-center" style="width: 150px">Số lượng</th>
                  <th class="text-right" style="width: 160px">Thành tiền</th>
                  <th style="width: 60px"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td colspan="6" class="text-center text-muted py-5">
                    Đang tải giỏ hàng...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="d-flex justify-content-between">
            <a href="./sanpham/sanpham.html" class="btn btn-outline-secondary"
              >← Tiếp tục mua sắm</a
            >
            <button id="btnClear" class="btn btn-outline-danger">
              Xóa giỏ hàng
            </button>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Tổng cộng</h5>
              <div class="d-flex justify-content-between">
                <span>Tạm tính</span>
                <strong id="subTotal">0₫</strong>
              </div>
              <div class="d-flex justify-content-between">
                <span>Phí vận chuyển</span>
                <span class="text-muted">Tính ở bước sau</span>
              </div>
              <hr />
              <div class="d-flex justify-content-between">
                <span>Tổng thanh toán</span>
                <strong id="grandTotal">0₫</strong>
              </div>
              <a
                id="btnCheckout"
                href="./checkout.html"
                class="btn btn-primary btn-block mt-3"
                >Thanh toán</a
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <footer class="footer">
      <div class="site-footer">
        <div class="top-footer">
          <div class="container">
            <div class="row">
              <section class="widget-ft">
                <h4 class="title-menu">Thông tin</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="./index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="./gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="./sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="./tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="./lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hỗ trợ</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="./index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="./gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="./sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="./tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="./lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Hướng dẫn</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="./index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="./gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="./sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="./tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="./lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="widget-ft">
                <h4 class="title-menu">Chính sách</h4>
                <ul class="list-menu">
                  <li class="li_menu">
                    <a href="./index.html">Trang chủ</a>
                  </li>
                  <li class="li_menu">
                    <a href="./gioithieu.html">Giới thiệu</a>
                  </li>
                  <li class="li_menu">
                    <a href="./sanpham/sanpham.html">Sản phẩm</a>
                  </li>
                  <li class="li_menu"><a href="./tintuc.html">Tin tức</a></li>
                  <li class="li_menu"><a href="./lienhe.html">Liên hệ</a></li>
                </ul>
              </section>

              <section class="wg-logo">
                <h4 class="title-menu">Liên hệ</h4>
                <ul class="contact">
                  <li>
                    <span class="txt_content_child">
                      <span
                        ><i
                          class="fa-solid fa-location-dot"
                          aria-hidden="true"
                        ></i
                      ></span>
                      140B-Tổ 3, Ấp Xóm Chùa,Tỉnh Tây Ninh
                    </span>
                  </li>
                  <li class="sdt">
                    <span
                      ><i class="fa-solid fa-phone" aria-hidden="true"></i
                    ></span>
                    <a href="tel:0338286525">0338286525</a>
                  </li>
                  <li class="sdt">
                    <span><i class="fa-solid fa-envelope"></i></span>
                    <a href="mailto:thanhloc29052006@gmail.com"
                      >thanhloc29052006@gmail.com</a
                    >
                  </li>
                </ul>
              </section>
            </div>
          </div>
        </div>

        <div class="mid-footer">
          <div class="container">
            <div class="row">
              <div class="fot_copyright">
                <span class="wsp"
                  ><span
                    >Cung cấp bởi <a href="javascript:;">Nhóm 7</a></span
                  ></span
                >
              </div>
              <nav class="fot_menu_copyright">
                <ul class="ul_menu_fot">
                  <li>
                    <a href="./index.html" title="Trang chủ">Trang chủ</a>
                  </li>
                  <li>
                    <a href="./gioithieu.html" title="Giới thiệu">Giới thiệu</a>
                  </li>
                  <li>
                    <a href="./sanpham/sanpham.html" title="Sản phẩm"
                      >Sản phẩm</a
                    >
                  </li>
                  <li><a href="./tin-tuc" title="Tin tức">Tin tức</a></li>
                  <li><a href="./lienhe.html" title="Liên hệ">Liên hệ</a></li>
                </ul>
              </nav>
              <div class="pay_footer">
                <ul class="follow_option">
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_1.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_2.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_3.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_4.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_5.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_6.webp"
                        alt="Payment"
                    /></a>
                  </li>
                  <li>
                    <a href="#"
                      ><img
                        src="./assets/images/pay_7.webp"
                        alt="Payment"
                    /></a>
                  </li>
                </ul>
              </div>
              <a
                href="#"
                id="back-to-top"
                class="backtop"
                title="Lên đầu trang"
              >
                <i class="fa-solid fa-angle-up" aria-hidden="true"></i>
              </a>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <script src="./assets/js/auth.js"></script>
    <script src="./assets/js/auth.security.enforcer.js"></script>

    <script src="./assets/js/auth.modal.bridge.js"></script>
    <script src="./assets/js/products.seed.js"></script>
    <script src="./assets/js/store.js"></script>
    <script src="./assets/js/ui.js"></script>

    <script>
      // Đợi trang tải xong
      document.addEventListener("DOMContentLoaded", function () {
        // Đợi auth.js kiểm tra xong
        AUTH.check().then(() => {
          // Bây giờ mới kiểm tra đăng nhập
          if (!window.AUTH.loggedIn) {
            alert("Vui lòng đăng nhập để xem giỏ hàng!");
            const back = location.pathname + location.search + location.hash;
            location.href =
              "./account/login.html?redirect=" + encodeURIComponent(back);
            return;
          }

          // --- Toàn bộ code logic của giỏ hàng sẽ chạy ở đây ---
          const userInfo = document.getElementById("userInfo");
          const userName = document.getElementById("userName");
          const userEmail = document.getElementById("userEmail");

          if (window.AUTH.user) {
            userName.textContent = window.AUTH.user.name || "Khách";
            userEmail.textContent = window.AUTH.user.email || "";
            userInfo.style.display = "block";
          }

          const money = (n) => (Number(n) || 0).toLocaleString("vi-VN") + "₫";
          const body = document.querySelector("#cartTable tbody");
          const subTotalEl = document.getElementById("subTotal");
          const grandTotalEl = document.getElementById("grandTotal");
          const btnClear = document.getElementById("btnClear");

          function dataMap() {
            const list = window.SVStore.getAllProducts();
            return new Map(list.map((p) => [String(p.id), p]));
          }

          function render() {
            const map = dataMap();
            const cart = window.SVStore.getCart();

            body.innerHTML = cart.length
              ? cart.map(rowHTML).join("")
              : `<tr><td colspan="6" class="text-center text-muted py-5">
          Giỏ hàng trống. <a href="./sanpham/sanpham.html">Tiếp tục mua sắm</a>
        </td></tr>`;

            const total = window.SVStore.total();
            subTotalEl.textContent = money(total);
            grandTotalEl.textContent = money(total);
            window.SVUI?.updateCartCount?.();

            function rowHTML(x) {
              const p = map.get(String(x.id));
              if (!p) return "";
              const line = (Number(p.price) || 0) * (x.qty || 0);
              return `
          <tr data-id="${p.id}">
            <td><img src="${p.image}" alt="${
                p.name
              }" style="width:50px;height:50px;object-fit:cover"></td>
            <td>${p.name}</td>
            <td class="text-right">${money(p.price)}</td>
            <td class="text-center">
              <div class="input-group input-group-sm justify-content-center">
                <div class="input-group-prepend"><button class="btn btn-outline-secondary btn-dec" type="button">–</button></div>
                <input class="form-control text-center qty" style="max-width:60px" value="${
                  x.qty
                }">
                <div class="input-group-append"><button class="btn btn-outline-secondary btn-inc" type="button">+</button></div>
              </div>
            </td>
            <td class="text-right">${money(line)}</td>
            <td class="text-center"><button class="btn btn-sm btn-outline-danger btn-del"><i class="fas fa-trash"></i></button></td>
          </tr>`;
            }
          }

          document.addEventListener("click", function (e) {
            const tr = e.target.closest("tr[data-id]");
            if (!tr) return;
            const id = tr.getAttribute("data-id");
            if (e.target.closest(".btn-inc")) {
              const cur = Number(tr.querySelector(".qty").value) || 1;
              window.SVStore.setQty(id, cur + 1);
              render();
            } else if (e.target.closest(".btn-dec")) {
              const cur = Number(tr.querySelector(".qty").value) || 1;
              if (cur > 1) {
                window.SVStore.setQty(id, cur - 1);
                render();
              }
            } else if (e.target.closest(".btn-del")) {
              if (confirm("Xóa sản phẩm này khỏi giỏ hàng?")) {
                window.SVStore.removeFromCart(id);
                render();
              }
            }
          });

          document.addEventListener("change", function (e) {
            const input = e.target.closest(".qty");
            if (!input) return;
            const tr = input.closest("tr[data-id]");
            const id = tr.getAttribute("data-id");
            const val = Math.max(1, Number(input.value) || 1);
            window.SVStore.setQty(id, val);
            render();
          });

          btnClear.addEventListener("click", () => {
            if (confirm("Xóa toàn bộ giỏ hàng?")) {
              window.SVStore.clearCart();
              render();
            }
          });

          render();
        });
      });
    </script>
    <script>
      (function () {
        function isMobile() {
          return window.matchMedia("(max-width: 767.98px)").matches;
        }

        function setInitialState() {
          document
            .querySelectorAll(".site-footer .widget-ft")
            .forEach((box, i) => {
              // Mặc định: đóng hết, riêng cột cuối "Liên hệ" mở sẵn (tuỳ bạn)
              if (isMobile()) {
                if (
                  box
                    .querySelector(".title-menu")
                    ?.textContent.trim()
                    .toLowerCase()
                    .includes("liên hệ")
                ) {
                  box.classList.add("is-open");
                } else {
                  box.classList.remove("is-open");
                }
              } else {
                box.classList.add("is-open"); // PC luôn mở
              }
            });
        }

        // Toggle khi bấm tiêu đề (chỉ mobile)
        function bindClick() {
          document
            .querySelectorAll(".site-footer .widget-ft .title-menu")
            .forEach((title) => {
              title.addEventListener("click", () => {
                if (!isMobile()) return; // PC không toggle
                const box = title.closest(".widget-ft");
                if (!box) return;
                box.classList.toggle("is-open");
              });
            });
        }

        // Khởi tạo
        document.addEventListener("DOMContentLoaded", () => {
          setInitialState();
          bindClick();
        });
        // Đổi trạng thái khi resize giữa mobile/PC
        window.addEventListener("resize", setInitialState);
      })();
    </script>
    <!-- cuối body, sau các script khác -->
  </body>
</html>
